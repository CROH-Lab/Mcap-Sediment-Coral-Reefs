---
title: "Coral Exp 1"
output: html_document
date: "2023-10-05"
---

### Data QA/QC
This chunk is grabbing the columns we need, and changing the column names so that it is in usable form for respR
```{r}
setwd("/Users/alexgood/Desktop/Coral Chapter/Respy data/Experiment 1")
library(knitr)
library(ggplot2)
library(cowplot)
library(respR)
library(WriteXLS)

# define buffer and measure periods
flush <- 120 #two min flush
wait <- 120   # 2 mins wait
measure <- 600  # 10 mins measure (measure)
# 840 seconds total
```

# Experiment 1 notes
lights turn on at 7am and turned off at 7pm (19:00)
flushed 6:25-6:27
in dark, oxygen will decrease, no photosynthesis, so find the spot where oxygen starts to increase = flushing 
6/30/21 - first flush around 7:03
dosed sediment at 7:30
8:04 stopped everything?
8:32 next?
8:59 - TA samples 9/10
9:27 - 11/12
9:55
10:24
10:53
11:19
11:47
12:15
12:43
12:45
13:13
13:39
14:07
14:35
15:03
15:31
15:59
16:27
16:55
17:23
17:51 - last flush
19:01 - last flush just TA no turb 
flush starts every 14 minutes - 840 seconds - 840 rows of data until next flush 
find when a flush starts and then count rows until next flush

# explore graphs to see when flush starts 
```{r}
subset_time <- c1_time[55408:55486, ] # 55408 = 6:24:42 - start of flush 

ggplot(subset_time, aes(x = Time, y = Oxygen)) +
  geom_point(color = "blue")
```

## Chamber 1 

# Setting the environment
```{r}
c1 <- read.csv("experiment 1_ch1.csv")
View(c1)

# Define time boundaries
start_day1 <- ymd_hms("2021-06-29 12:06:56")
end_day1   <- ymd_hms("-06-29 19:06:56")

start_night1 <- end_day1
end_night1   <- ymd_hms("2023-08-02 07:00:00")

start_day2 <- end_night1
end_day2   <- ymd_hms("2023-08-02 19:00:00")

start_night2 <- end_day2
end_night2   <- ymd_hms("2023-08-03 07:00:00")


c1_time <- c1[, c("Delta.T..min.", "Time", "Oxygen", "Temperature")]
c1_time <- subset_data(c1_time, from = 10420, to = 155355, by = "row") # keep the time in to track day and night
View(c1_time)
#c1_time just used for reference, not for analysis
c1_final <- c1[, c("Delta.T..min.", "Oxygen", "Temperature")]
c1_final <- plyr::rename(c1_final, c("Delta.T..min."="Time")) 
c1_final<-subset_data(c1_final, from = 10420, to = 155355, by = "row") # deleted some of the first day, not important part of analysis
View(c1_final)
# make sure c1 and c1_time match starting point

# careful not to subset data and then subset again ... want to use the original data before any subsetting to start find the initial and final flushes (below)
subset_time <- c1[10420:10545, ] # 55408 = 6:24:42 - start of flush 
ggplot(subset_time, aes(x = Time, y = Oxygen)) +
  geom_point(color = "blue")

subset_time <- c1[155100:155355, ] # 55408 = 6:24:42 - start of flush 
ggplot(subset_time, aes(x = Time, y = Oxygen)) +
  geom_point(color = "blue")

ggplot(c1_time, aes(x = Time, y = Temperature)) +
  geom_line() +
  labs(title = "Temperature Over Time",
       x = "Time",
       y = "Temperature (Â°C)") +
  theme_minimal()
```

# ALL RATES
```{r}
##We want rate.rev to be false so that production is positive, and consumption is negative
test <- inspect(c1_final, rate.rev = FALSE, width = 0.2) # see all 4 days 
reps <- seq(1, 144096, 840) # 172 loops
nrow(c1_final)
144936-840
## data starts - apply wait and flush periods
starts <- reps + wait + flush
starts
## data ends - apply wait and flush AND measure periods
ends <- reps + wait + flush + measure
ends

# ALL RATES
rates_all <- calc_rate.int(test, 
                       starts=reps,
                       wait=240,
                       measure=600,
                       quiet = TRUE,
                       pos=c(100:160),
                       legend=TRUE)
summary(rates_all)
```

# DAY 1
```{r}
subset_time <- c1_time[14280:14700, ] # 55408 = 6:24:42 - start of flush 
ggplot(subset_time, aes(x = Time, y = Oxygen)) +
  geom_point(color = "blue")

301114-3600

c1_day1 <- subset_data(c1_final, from = 1, to = 14280, by = "row") # ends 18:58:37 (7pm)
nrow(c1_day1) # 14280
test_day1 <- inspect(c1_day1, rate.rev = FALSE, width = 0.2)
14280- 840 #13440
reps_day1 <- seq(1, 13440, 840) # 16 loops
rates_c1_day1 <- calc_rate.int(test_day1, 
                       starts=reps_day1,
                       wait=240,
                       measure=600,
                       quiet = TRUE,
                       legend=TRUE,
                       export=TRUE)

summary(rates_c1_day1) #all above 0.85

# Convert
rates_con <- convert_rate(rates_c1_day1, oxy.unit = "umol/L", 
                    time.unit = "sec",
                    output.unit = "mg/h/g",
                    volume = 573.41,
                    mass = 26.59)
summary(rates_con)
plot(rates_con, type="rate")
mo2 <- rates_con[["summary"]][['rate.output']]
mo2
rsq <- rates_con[["summary"]][['rsq']]
rsq
time <- 1:length(mo2)
day1 <- data.frame(time, rsq, mo2)
View(day1)
WriteXLS(day1, "exp1_ch1_day1.xlsx")

# TEMP
summary_temp <- c1_day1 %>%
  summarise(
    mean_temp = mean(Temperature, na.rm = TRUE),
    sd_temp = sd(Temperature, na.rm = TRUE)
  )
summary_temp
```


# NIGHT 1
```{r}
subset_time <- c1_time[57950:58300, ] # 55408 = 6:24:42 - start of flush 
ggplot(subset_time, aes(x = Time, y = Oxygen)) +
  geom_point(color = "blue")

c1_night1 <- subset_data(c1_final, from = 14280, to = 57950, by = "row") # 18:58:37 to  7:06:33 am
nrow(c1_night1) #43671
test_night1 <- inspect(c1_night1, rate.rev = FALSE, width = 0.2)
43671 - 840 #42831
reps_night1 <- seq(1, 42831, 840) # # 51 loops
rates_c1_night1 <- calc_rate.int(test_night1, 
                       starts=reps_night1,
                       wait=240,
                       measure=600,
                       quiet = TRUE,
                       pos=c(1:51),
                       legend=TRUE)

summary(rates_c1_night1) # all above 0.95

# Convert
rates_con <- convert_rate(rates_c1_night1, oxy.unit = "umol/L", 
                    time.unit = "sec",
                    output.unit = "mg/h/g",
                    volume = 573.41,
                    mass = 26.59)
summary(rates_con)
plot(rates_con, type="rate")
mo2 <- rates_con[["summary"]][['rate.output']]
mo2
rsq <- rates_con[["summary"]][['rsq']]
rsq
time <- 1:length(mo2)
night1 <- data.frame(time, rsq, mo2)
View(night1)
WriteXLS(night1, "exp1_ch1_night1.xlsx")

# TEMP
summary_temp <- c1_night1 %>%
  summarise(
    mean_temp = mean(Temperature, na.rm = TRUE),
    sd_temp = sd(Temperature, na.rm = TRUE)
  )
summary_temp
```

# DAY 2
```{r}
subset_time <- c1_time[101200:101620, ] # 55408 = 6:24:42 - start of flush 
ggplot(subset_time, aes(x = Time, y = Oxygen)) +
  geom_point(color = "blue")

c1_day2 <- subset_data(c1_final, from = 57920, to = 100780, by = "row") # 7:06:03 to 19:00:44
nrow(c1_day2) # 42861
test_day2 <- inspect(c1_day2, rate.rev = FALSE, width = 0.2)
42861 - 840
reps_day2 <- seq(1, 42021, 840) # 51 loops
rates_c1_day2 <- calc_rate.int(test_day2, 
                       starts=reps_day2,
                       wait=240,
                       measure=600,
                       quiet = TRUE,
                       pos=c(30:50),
                       legend=TRUE)

summary(rates_c1_day2) # a lot of variability not great rsq

# Convert
rates_con <- convert_rate(rates_c1_day2, oxy.unit = "umol/L", 
                    time.unit = "sec",
                    output.unit = "mg/h/g",
                    volume = 573.41,
                    mass = 26.59)
summary(rates_con)
plot(rates_con, type="rate")
mo2 <- rates_con[["summary"]][['rate.output']]
mo2
rsq <- rates_con[["summary"]][['rsq']]
rsq
time <- 1:length(mo2)
day2 <- data.frame(time, rsq, mo2)
View(day2)
WriteXLS(day2, "exp1_ch1_day2.xlsx")

# TEMP
summary_temp <- c1_day2 %>%
  summarise(
    mean_temp = mean(Temperature, na.rm = TRUE),
    sd_temp = sd(Temperature, na.rm = TRUE)
  )
summary_temp
```

# NIGHT 2
```{r}
subset_time <- c1_time[144000:144455, ] # 55408 = 6:24:42 - start of flush 
ggplot(subset_time, aes(x = Time, y = Oxygen)) +
  geom_point(color = "blue")

c1_night2 <- subset_data(c1_final, from = 100750, to = 143615, by = "row") # 19:00:14 to 6:54:43 am	
nrow(c1_night2) # 42866
test_night2 <- inspect(c1_night2, rate.rev = FALSE, width = 0.2)
42866 - 840
reps_night2 <- seq(1, 42026, 840) # 51 loops
rates_c1_night2 <- calc_rate.int(test_night2, 
                       starts=reps_night2,
                       wait=240,
                       measure=600,
                       quiet = TRUE,
                       pos=c(30:51),
                       legend=TRUE)

summary(rates_c1_night2) # not great rsq

# Convert
rates_con <- convert_rate(rates_c1_night2, oxy.unit = "umol/L", 
                    time.unit = "sec",
                    output.unit = "mg/h/g",
                    volume = 573.41,
                    mass = 26.59)
summary(rates_con)
plot(rates_con, type="rate")
mo2 <- rates_con[["summary"]][['rate.output']]
mo2
rsq <- rates_con[["summary"]][['rsq']]
rsq
time <- 1:length(mo2)
night2 <- data.frame(time, rsq, mo2)
View(day2)
WriteXLS(night2, "exp1_ch1_night2.xlsx")
```


## Chamber 2 

# Setting the Environment
```{r}
c2 <- read.csv("experiment 1_ch2.csv")
c2_time <- c2[, c("Delta.T..min.", "Time", "Oxygen")]
c2_time <- subset_data(c2_time, from = 1175, to = 156590, by = "row") # keep the time in to track day and night
View(c2_time)

c2_final <- c2[, c("Delta.T..min.", "Oxygen")]
c2_final <- plyr::rename(c2_final, c("Delta.T..min."="Time")) 
c2_final<-subset_data(c2_final, from = 1175, to = 156590, by = "row")
View(c2_final)

# explore graphs to see when flush starts 
subset_time <- c2[850:1190, ] # 1186 = 12:26:44 - start of flush on day 1
ggplot(subset_time, aes(x = Time, y = Oxygen)) +
  geom_point(color = "blue")

```

# ALL RATES
```{r}
##We want rate.rev to be false so that production is positive, and consumption is negative
test2 <- inspect(c2_final, rate.rev = FALSE, width = 0.2) # see all 4 days 
reps <- seq(1, 154576, 840) # 184 loops - second number is 155390-840
nrow(c2_final)
155416-840
154576/840

rates_all <- calc_rate.int(test2, 
                       starts=reps,
                       wait=240,
                       measure=600,
                       quiet = TRUE,
                       pos=c(120:184),
                       legend=TRUE)

summary(rates_all)
```

# DAY 1
```{r}
c2_day1 <- subset_data(c2_final, from = 1, to = 23520, by = "row") # 12:26 - ends 18:58:35 (7pm)
nrow(c2_day1) # 23520
test_day1 <- inspect(c2_day1, rate.rev = FALSE, width = 0.2)
23520- 840 #22680
reps_day1 <- seq(1, 22680, 840) # 27 loops
rates_day1 <- calc_rate.int(test_day1, 
                       starts=reps_day1,
                       wait=240,
                       measure=600,
                       quiet = TRUE,
                       pos=c(1:27),
                       legend=TRUE)

summary(rates_day1) # good rsq

# Convert
rates_con <- convert_rate(rates_day1, oxy.unit = "umol/L", 
                    time.unit = "sec",
                    output.unit = "mg/h/g",
                    volume = 561.37,
                    mass = 38.63)

summary(rates_con)
plot(rates_con, type="rate")
mo2 <- rates_con[["summary"]][['rate.output']]
mo2
rsq <- rates_con[["summary"]][['rsq']]
rsq
time <- 1:length(mo2)
day1 <- data.frame(time, rsq, mo2)
View(day1)
WriteXLS(day1, "exp1_ch2_day1.xlsx")
```

# NIGHT 1
```{r}
subset_time <- c2_final[67155:67300, ] # 1186 = 12:26:44 - start of flush on day 1
ggplot(subset_time, aes(x = Time, y = Oxygen)) +
  geom_point(color = "blue")
# 67165 = 7:06:41 am 

c2_night1 <- subset_data(c2_final, from = 23521, to = 67150, by = "row") # 18:58:36 to 7:05:51 am
nrow(c2_night1) #43630
test_night1 <- inspect(c2_night1, rate.rev = FALSE, width = 0.2)
43630 - 840 #42790
reps_night1 <- seq(1, 42790, 840) # # 51 loops
rates_night1 <- calc_rate.int(test_night1, 
                       starts=reps_night1,
                       wait=240,
                       measure=600,
                       quiet = TRUE,
                       pos=c(1:51),
                       legend=TRUE)

summary(rates_night1) # all above 0.90

# Convert
rates_con <- convert_rate(rates_night1, oxy.unit = "umol/L", 
                    time.unit = "sec",
                    output.unit = "mg/h/g",
                    volume = 575.17,
                    mass = 24.83)

summary(rates_con)
plot(rates_con, type="rate")
mo2 <- rates_con[["summary"]][['rate.output']]
mo2
rsq <- rates_con[["summary"]][['rsq']]
rsq
time <- 1:length(mo2)
night1 <- data.frame(time, rsq, mo2)
View(night1)
WriteXLS(night1, "exp1_ch2_night1.xlsx")
```

# DAY 2
```{r}
subset_time <- c2_final[109300:109980, ]
ggplot(subset_time, aes(x = Time, y = Oxygen)) +
  geom_point(color = "blue")
# 109985 = 19:00:37

c2_day2 <- subset_data(c2_final, from = 67150, to = 109980, by = "row") # 7:05:51 am to 19:00:02
nrow(c2_day2) # 42831
test_day2 <- inspect(c2_day2, rate.rev = FALSE, width = 0.2)
42831 - 840
reps_day2 <- seq(1, 41991, 840) # 50 loops
rates_day2 <- calc_rate.int(test_day2, 
                       starts=reps_day2,
                       wait=240,
                       measure=600,
                       quiet = TRUE,
                       pos=c(10:50),
                       legend=TRUE)

summary(rates_day2) # a lot of variability but most above 0.75 or 0.8 so good

# Convert
rates_con <- convert_rate(rates_day2, oxy.unit = "umol/L", 
                    time.unit = "sec",
                    output.unit = "mg/h/g",
                    volume = 561.37,
                    mass = 38.63)

summary(rates_con)
plot(rates_con, type="rate")
mo2 <- rates_con[["summary"]][['rate.output']]
mo2
rsq <- rates_con[["summary"]][['rsq']]
rsq
time <- 1:length(mo2)
day2 <- data.frame(time, rsq, mo2)
View(day2)
WriteXLS(day2, "exp1_ch2_day2.xlsx")
```

# NIGHT 2
```{r}
subset_time <- c2_final[109980:110100, ]
ggplot(subset_time, aes(x = Time, y = Oxygen)) +
  geom_point(color = "blue")

subset_time <- c2_final[152000:152820, ]
ggplot(subset_time, aes(x = Time, y = Oxygen)) +
  geom_point(color = "blue")

c2_night2 <- subset_data(c2_final, from = 109980, to = 152820, by = "row") # 19:00:02 to 6:54:41 am	
nrow(c2_night2) # 42841
test_night2 <- inspect(c2_night2, rate.rev = FALSE, width = 0.2)
42841- 840
reps_night2 <- seq(1, 42001, 840) # 51 loops
rates_night2 <- calc_rate.int(test_night2, 
                       starts=reps_night2,
                       wait=240,
                       measure=600,
                       quiet = TRUE,
                       pos=c(10:51),
                       legend=TRUE)

summary(rates_night2) # less variability but most above 0.70 or 0.75

# Convert
rates_con <- convert_rate(rates_night2, oxy.unit = "umol/L", 
                    time.unit = "sec",
                    output.unit = "mg/h/g",
                    volume = 561.37,
                    mass = 38.63)

summary(rates_con)
plot(rates_con, type="rate")
mo2 <- rates_con[["summary"]][['rate.output']]
mo2
rsq <- rates_con[["summary"]][['rsq']]
rsq
time <- 1:length(mo2)
night2 <- data.frame(time, rsq, mo2)
View(night2)
WriteXLS(night2, "exp1_ch2_night2.xlsx")
```


## Chamber 3

# Setting the Environment
```{r}
c3 <- read.csv("experiment 1_ch3.csv")
c3_time <- c3[, c("Delta.T..min.", "Time", "Oxygen")]
c3_time <- subset_data(c3_time, from = 330, to = 156540, by = "row") # keep the time in to track day and night
View(c3_time)

c3_final <- c3[, c("Delta.T..min.", "Oxygen")]
c3_final <- plyr::rename(c3_final, c("Delta.T..min."="Time")) 
c3_final <- subset_data(c3_final, from = 330, to = 156530, by = "row")
View(c3_final)

# explore graphs to see when flush starts 
subset_time <- c3[320:700, ] # 1186 = 12:26:44 - start of flush on day 1
ggplot(subset_time, aes(x = Time, y = Oxygen)) +
  geom_point(color = "blue")

subset_time <- c3[156200:156530, ] # 1186 = 12:26:44 - start of flush on day 1
ggplot(subset_time, aes(x = Time, y = Oxygen)) +
  geom_point(color = "blue")
```

# ALL RATES
```{r}
##We want rate.rev to be false so that production is positive, and consumption is negative
test2 <- inspect(c3_final, rate.rev = FALSE, width = 0.2) # see all 4 days 
reps <- seq(1, 155700, 840) # 185 loops - second number is 155390-840


rates_all <- calc_rate.int(test2, 
                       starts=reps,
                       wait=120,
                       measure=600,
                       quiet = TRUE,
                       pos=c(170:186),
                       legend=TRUE)

summary(rates_all)
```

# DAY 1
```{r}
subset_time <- c3_final[24300:24700, ] # 1186 = 12:26:44 - start of flush on day 1
ggplot(subset_time, aes(x = Time, y = Oxygen)) +
  geom_point(color = "blue")
#24700 = 19:04:27

c3_day1 <- subset_data(c3_final, from = 1, to = 24700, by = "row") # 12:12:45 - ends 19:04:12 (7pm)
nrow(c3_day1) # 24700
test_day1 <- inspect(c3_day1, rate.rev = FALSE, width = 0.2)
24700- 840 #22680
reps_day1 <- seq(1, 23860, 840) # 29 loops
rates_day1 <- calc_rate.int(test_day1, 
                       starts=reps_day1,
                       wait=240,
                       measure=600,
                       quiet = TRUE,
                       pos=c(1:29),
                       legend=TRUE)

summary(rates_day1) #all above 0.8

# Convert
rates_con <- convert_rate(rates_day1, oxy.unit = "umol/L", 
                    time.unit = "sec",
                    output.unit = "mg/h/g",
                    volume = 579.33,
                    mass = 20.67)

summary(rates_con)
plot(rates_con, type="rate")
mo2 <- rates_con[["summary"]][['rate.output']]
mo2
rsq <- rates_con[["summary"]][['rsq']]
rsq
time <- 1:length(mo2)
day1 <- data.frame(time, rsq, mo2)
View(day1)
WriteXLS(day1, "exp1_ch3_day1.xlsx")
```

# NIGHT 1
```{r}
subset_time <- c3_final[24350:25200, ] # 1186 = 12:26:44 - start of flush on day 1
ggplot(subset_time, aes(x = Time, y = Oxygen)) +
  geom_point(color = "blue")

subset_time <- c3_final[68030:68400, ] # 1186 = 12:26:44 - start of flush on day 1
ggplot(subset_time, aes(x = Time, y = Oxygen)) +
  geom_point(color = "blue")
# 67165 = 7:06:41 am 

c3_night1 <- subset_data(c3_final, from = 24350, to = 68035, by = "row") # 18:58:22 to   7:06:32 am
nrow(c3_night1) #43686
test_night1 <- inspect(c3_night1, rate.rev = FALSE, width = 0.2)
43686 - 840 #42846
reps_night1 <- seq(1, 42496, 840) # # 51 loops
rates_night1 <- calc_rate.int(test_night1, 
                       starts=reps_night1,
                       wait=240,
                       measure=600,
                       quiet = TRUE,
                       pos=c(1:51),
                       legend=TRUE)

summary(rates_night1) # all low around 0.5 

# Convert
rates_con <- convert_rate(rates_night1, oxy.unit = "umol/L", 
                    time.unit = "sec",
                    output.unit = "mg/h/g",
                    volume = 579.33,
                    mass = 20.67)

summary(rates_con)
plot(rates_con, type="rate")
mo2 <- rates_con[["summary"]][['rate.output']]
mo2
rsq <- rates_con[["summary"]][['rsq']]
rsq
time <- 1:length(mo2)
night1 <- data.frame(time, rsq, mo2)
View(night1)
WriteXLS(night1, "exp1_ch3_night1.xlsx")
```

# DAY 2
```{r}
subset_time <- c3_final[109500:110008, ]
ggplot(subset_time, aes(x = Time, y = Oxygen)) +
  geom_point(color = "blue")
# 109985 = 19:00:37

c3_day2 <- subset_data(c3_final, from = 68025, to = 110848, by = "row") # 7:06:23 to 19:00:27
nrow(c3_day2) # 42824
test_day2 <- inspect(c3_day2, rate.rev = FALSE, width = 0.2)
42824 - 840
reps_day2 <- seq(1, 41984, 840) # 50 loops
rates_day2 <- calc_rate.int(test_day2, 
                       starts=reps_day2,
                       wait=240,
                       measure=600,
                       quiet = TRUE,
                       pos=c(30:50),
                       legend=TRUE)

summary(rates_day2) # a lot of variability but most above 0.75 or 0.8

# Convert
rates_con <- convert_rate(rates_day2, oxy.unit = "umol/L", 
                    time.unit = "sec",
                    output.unit = "mg/h/g",
                    volume = 579.33,
                    mass = 20.67)

summary(rates_con)
plot(rates_con, type="rate")
mo2 <- rates_con[["summary"]][['rate.output']]
mo2
rsq <- rates_con[["summary"]][['rsq']]
rsq
time <- 1:length(mo2)
day2 <- data.frame(time, rsq, mo2)
View(day2)
WriteXLS(day2, "exp1_ch3_day2.xlsx")
```

# NIGHT 2
```{r}
subset_time <- c3_final[109980:110100, ]
ggplot(subset_time, aes(x = Time, y = Oxygen)) +
  geom_point(color = "blue")

subset_time <- c3_final[153900:154540, ]
ggplot(subset_time, aes(x = Time, y = Oxygen)) +
  geom_point(color = "blue")

c3_night2 <- subset_data(c3_final, from = 110848, to = 153695, by = "row") # 19:00:02 to 6:54:38 am	
nrow(c3_night2) # 42848
test_night2 <- inspect(c3_night2, rate.rev = FALSE, width = 0.2)
42848-840
reps_night2 <- seq(1, 42008, 840) # 51 loops
rates_night2 <- calc_rate.int(test_night2, 
                       starts=reps_night2,
                       wait=240,
                       measure=600,
                       quiet = TRUE,
                       pos=c(30:51),
                       legend=TRUE)

summary(rates_night2) # really good all above 0.9

# Convert
rates_con <- convert_rate(rates_night2, oxy.unit = "umol/L", 
                    time.unit = "sec",
                    output.unit = "mg/h/g",
                    volume = 579.33,
                    mass = 20.67)

summary(rates_con)
plot(rates_con, type="rate")
mo2 <- rates_con[["summary"]][['rate.output']]
mo2
rsq <- rates_con[["summary"]][['rsq']]
rsq
time <- 1:length(mo2)
night2 <- data.frame(time, rsq, mo2)
View(night2)
WriteXLS(night2, "exp1_ch3_night2.xlsx")
```


## Chamber 4

# Setting the Environment
```{r}
c4 <- read.csv("experiment 1_ch4.csv")
c4_time <- c4[, c("Delta.T..min.", "Time", "Oxygen")]
c4_time <- subset_data(c4_time, from = 1170, to = 154020, by = "row") # keep the time in to track day and night
View(c4_time)

c4_final <- c4[, c("Delta.T..min.", "Oxygen")]
c4_final <- plyr::rename(c4_final, c("Delta.T..min."="Time")) 
c4_final <- subset_data(c4_final, from = 1170, to = 154020, by = "row")
View(c4_final)
# start by defining the first flush and the last flush to build the cycles out from there 

# explore graphs to see when flush starts 
subset_time <- c4[335:700, ] # 1186 = 12:26:44 - start of flush on day 1
ggplot(subset_time, aes(x = Time, y = Oxygen)) +
  geom_point(color = "blue")
# start at 12:26:23

subset_time <- c4[154020:154500, ] # 1186 = 12:26:44 - start of flush on day 1
ggplot(subset_time, aes(x = Time, y = Oxygen)) +
  geom_point(color = "blue")
# end at 6:54:27
```

# ALL RATES
```{r}
##We want rate.rev to be false so that production is positive, and consumption is negative
test2 <- inspect(c4_final, rate.rev = FALSE, width = 0.2) # see all 4 days 
reps <- seq(1, 152011, 840) # 181 loops - second number is 155390-840
nrow(c4_final)
152851-840
152011/840

# RATES
rates_all <- calc_rate.int(test2, 
                       starts=reps,
                       wait=240,
                       measure=600,
                       quiet = TRUE,
                       pos=c(80:181),
                       legend=TRUE)

summary(rates_all)
# don't spend time looking at the full dataset, you can break it up into days easier if there are weird spots in the data
```

# DAY 1 IGNORED - DATA WAS 0
18:58:40 is row 23535


# NIGHT 1 IGNORED - DATA STILL O?
row 67195 starts day 2

# DAY 2
```{r}
subset_time <- c4_final[67200:67500, ]
ggplot(subset_time, aes(x = Time, y = Oxygen)) +
  geom_point(color = "blue")

subset_time <- c4_final[109170:110008, ]
ggplot(subset_time, aes(x = Time, y = Oxygen)) +
  geom_point(color = "blue")
# 109985 = 19:00:37

c4_day2 <- subset_data(c4_final, from = 67190, to = 110010, by = "row") # 7:06:26 to 19:00:22
nrow(c4_day2) # 42821
test_day2 <- inspect(c4_day2, rate.rev = FALSE, width = 0.2)
42821 - 840
reps_day2 <- seq(1, 41981, 840) # 50 loops
rates_day2 <- calc_rate.int(test_day2, 
                       starts=reps_day2,
                       wait=240,
                       measure=600,
                       quiet = TRUE,
                       pos=c(20:50),
                       legend=TRUE)

summary(rates_day2) # a lot of variability and not great

# Convert
rates_con <- convert_rate(rates_day2, oxy.unit = "umol/L", 
                    time.unit = "sec",
                    output.unit = "mg/h/g",
                    volume = 556.14,
                    mass = 43.86)

summary(rates_con)
plot(rates_con, type="rate")
mo2 <- rates_con[["summary"]][['rate.output']]
mo2
rsq <- rates_con[["summary"]][['rsq']]
rsq
time <- 1:length(mo2)
day2 <- data.frame(time, rsq, mo2)
View(day2)
WriteXLS(day2, "exp1_ch4_day2.xlsx")
```

# NIGHT 2
```{r}
subset_time <- c4_final[109980:110100, ]
ggplot(subset_time, aes(x = Time, y = Oxygen)) +
  geom_point(color = "blue")

subset_time <- c4_final[152100:154300, ]
ggplot(subset_time, aes(x = Time, y = Oxygen)) +
  geom_point(color = "blue")

c4_night2 <- subset_data(c4_final, from = 110010, to = 152851, by = "row") # 19:00:02 to 6:54:38 am	
nrow(c4_night2) # 42842
test_night2 <- inspect(c4_night2, rate.rev = FALSE, width = 0.2)
42842-840
reps_night2 <- seq(1, 42002, 840) # 51 loops
rates_night2 <- calc_rate.int(test_night2, 
                       starts=reps_night2,
                       wait=240,
                       measure=600,
                       quiet = TRUE,
                       pos=c(1:51),
                       legend=TRUE)

summary(rates_night2) # really good all above 0.9

# Convert
rates_con <- convert_rate(rates_night2, oxy.unit = "umol/L", 
                    time.unit = "sec",
                    output.unit = "mg/h/g",
                    volume = 556.14,
                    mass = 43.86)

summary(rates_con)
plot(rates_con, type="rate")
mo2 <- rates_con[["summary"]][['rate.output']]
mo2
rsq <- rates_con[["summary"]][['rsq']]
rsq
time <- 1:length(mo2)
night2 <- data.frame(time, rsq, mo2)
View(night2)
WriteXLS(night2, "exp1_ch4_night2.xlsx")
```




